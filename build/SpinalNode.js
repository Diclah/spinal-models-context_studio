"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;
let getViewer = function () {
  return globalType.v;
};

class SpinalNode extends globalType.Model {
  constructor(_name, _element, _graph, _relations) {
    super();
    if (FileSystem._sig_server) {
      this.add_attr({
        name: _name,
        id: this.guid(),
        element: _element,
        relations: new Model(),
        graph: new Ptr(_graph)
      });
      if (typeof this.graph !== "undefined") {
        this.graph.load(g => {
          g.addVertex(this);
        });
      }
      if (typeof _relations !== "undefined") {
        if (Array.isArray(_relations) || _relations instanceof Lst) this.addRelations(_relations);else this.addRelation(_relations);
      }
    }
  }

  guid() {
    return this.constructor.name + "-" + this.s4() + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + this.s4() + this.s4() + "-" + Date.now().toString(16);
  }

  s4() {
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  }

  hasRelation() {
    return this.relations.length !== 0;
  }

  addRelation(_relation) {
    this.graph.load(graph => {
      graph.addRelation(_relation);
      graph._addNotExistingVerticesFromRelation(_relation);
    });
    if (typeof this.relations[_relation.type.get()] !== "undefined") this.relations[_relation.type.get()].load(relationList => {
      relationList.push(_relation);
    });else {
      let list = new Lst();
      list.push(_relation);
      this.relations.add_attr({
        [_relation.type.get()]: new Ptr(list)
      });
    }
  }

  addRelations(_relations) {
    for (let index = 0; index < _relations.length; index++) {
      this.addRelation(_relations[index]);
    }
  }

  promiseLoad(_ptr) {
    return new Promise(resolve => {
      _ptr.load(resolve);
    });
  }

  async getRelations(_type) {
    let res = [];
    if (typeof _type === "undefined") {
      for (let index = 0; index < this.relations.attr_attribute_names.length; index++) {
        const attribute = this.relations.attr_attribute_names[index];
        let relList = await this.promiseLoad(attribute);
        for (let index = 0; index < relList.length; index++) {
          const relation = relList[index];
          res.push(relation);
        }
      }
      return res;
    } else {
      let relList = await this.promiseLoad(this.relations[_type]);
      return relList;
    }
  }

  inVertexList(_vertexlist) {
    for (let index = 0; index < _vertexlist.length; index++) {
      const element = _vertexlist[index];
      if (element.id.get() === this.id.get()) return true;
    }
    return false;
  }

  allButMe(_list) {
    let res = [];
    for (let index = 0; index < _list.length; index++) {
      const vertex = _list[index];
      if (vertex.id.get() != this.id.get()) {
        res.push(vertex);
      }
      return res;
    }
  }

  async getNeighbors(_type) {
    neighbors = [];
    let relations = await this.getRelations(_type);
    for (let index = 0; index < relations.length; index++) {
      const relation = relations[index];
      if (relation.isDirected.get()) {
        if (this.inVertexList(relation.vertexlist1)) neighbors = neighbors.concat(relation.vertexlist2);else neighbors = neighbors.concat(relation.vertexlist1);
      } else {
        neighbors = neighbors.concat(this.allButMe(relation.vertexlist1));
        neighbors = neighbors.concat(this.allButMe(relation.vertexlist2));
      }
    }
    return neighbors;
  }

  async removeRelation(_relation) {
    let relationLst = await this.promiseLoad(this.relations[_relation.type.get()]);
    for (let index = 0; index < relationLst.length; index++) {
      const candidateRelation = relationLst[index];
      if (_relation.id.get() === candidateRelation.id.get()) relationLst.splice(index, 1);
    }
  }

  async removeRelations(_relations) {
    for (let index = 0; index < _relations.length; index++) {
      this.removeRelation(_relations[index]);
    }
  }

  removeRelationType(_type) {
    if (Array.isArray(_type) || _type instanceof Lst) for (let index = 0; index < _type.length; index++) {
      const type = _type[index];
      this.relations.rem_attr(type);
    } else {
      this.relations.rem_attr(_type);
    }
  }

}

exports.default = SpinalNode;
spinalCore.register_models([SpinalNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcGluYWxOb2RlLmpzIl0sIm5hbWVzIjpbInNwaW5hbENvcmUiLCJyZXF1aXJlIiwiZ2xvYmFsVHlwZSIsIndpbmRvdyIsImdsb2JhbCIsImdldFZpZXdlciIsInYiLCJTcGluYWxOb2RlIiwiTW9kZWwiLCJjb25zdHJ1Y3RvciIsIl9uYW1lIiwiX2VsZW1lbnQiLCJfZ3JhcGgiLCJfcmVsYXRpb25zIiwiRmlsZVN5c3RlbSIsIl9zaWdfc2VydmVyIiwiYWRkX2F0dHIiLCJuYW1lIiwiaWQiLCJndWlkIiwiZWxlbWVudCIsInJlbGF0aW9ucyIsImdyYXBoIiwiUHRyIiwibG9hZCIsImciLCJhZGRWZXJ0ZXgiLCJBcnJheSIsImlzQXJyYXkiLCJMc3QiLCJhZGRSZWxhdGlvbnMiLCJhZGRSZWxhdGlvbiIsInM0IiwiRGF0ZSIsIm5vdyIsInRvU3RyaW5nIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwic3Vic3RyaW5nIiwiaGFzUmVsYXRpb24iLCJsZW5ndGgiLCJfcmVsYXRpb24iLCJfYWRkTm90RXhpc3RpbmdWZXJ0aWNlc0Zyb21SZWxhdGlvbiIsInR5cGUiLCJnZXQiLCJyZWxhdGlvbkxpc3QiLCJwdXNoIiwibGlzdCIsImluZGV4IiwicHJvbWlzZUxvYWQiLCJfcHRyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRSZWxhdGlvbnMiLCJfdHlwZSIsInJlcyIsImF0dHJfYXR0cmlidXRlX25hbWVzIiwiYXR0cmlidXRlIiwicmVsTGlzdCIsInJlbGF0aW9uIiwiaW5WZXJ0ZXhMaXN0IiwiX3ZlcnRleGxpc3QiLCJhbGxCdXRNZSIsIl9saXN0IiwidmVydGV4IiwiZ2V0TmVpZ2hib3JzIiwibmVpZ2hib3JzIiwiaXNEaXJlY3RlZCIsInZlcnRleGxpc3QxIiwiY29uY2F0IiwidmVydGV4bGlzdDIiLCJyZW1vdmVSZWxhdGlvbiIsInJlbGF0aW9uTHN0IiwiY2FuZGlkYXRlUmVsYXRpb24iLCJzcGxpY2UiLCJyZW1vdmVSZWxhdGlvbnMiLCJy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LElBQUlvQixRQUFRLENBQWpCLEVBQW9CQSxRQUFRTSxNQUFNZCxNQUFsQyxFQUEwQ1EsT0FBMUMsRUFBbUQ7QUFDakQsWUFBTUwsT0FBT1csTUFBTU4sS0FBTixDQUFiO0FBQ0EsV0FBSzVCLFNBQUwsQ0FBZXlELFFBQWYsQ0FBd0JsQyxJQUF4QjtBQUNELEtBSkgsTUFLSztBQUNILFdBQUt2QixTQUFMLENBQWV5RCxRQUFmLENBQXdCdkIsS0FBeEI7QUFDRDtBQUNGOztBQTlLc0Q7O2tCQUFwQ2hELFU7QUFrTHJCUCxXQUFXK0UsZUFBWCxDQUEyQixDQUFDeEUsVUFBRCxDQUEzQiIsImZpbGUiOiJTcGluYWxOb2RlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc3BpbmFsQ29yZSA9IHJlcXVpcmUoXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc1wiKTtcbmNvbnN0IGdsb2JhbFR5cGUgPSB0eXBlb2Ygd2luZG93ID09PSBcInVuZGVmaW5lZFwiID8gZ2xvYmFsIDogd2luZG93O1xubGV0IGdldFZpZXdlciA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gZ2xvYmFsVHlwZS52O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3BpbmFsTm9kZSBleHRlbmRzIGdsb2JhbFR5cGUuTW9kZWwge1xuICBjb25zdHJ1Y3RvcihfbmFtZSwgX2VsZW1lbnQsIF9ncmFwaCwgX3JlbGF0aW9ucykge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKEZpbGVTeXN0ZW0uX3NpZ19zZXJ2ZXIpIHtcbiAgICAgIHRoaXMuYWRkX2F0dHIoe1xuICAgICAgICBuYW1lOiBfbmFtZSxcbiAgICAgICAgaWQ6IHRoaXMuZ3VpZCgpLFxuICAgICAgICBlbGVtZW50OiBfZWxlbWVudCxcbiAgICAgICAgcmVsYXRpb25zOiBuZXcgTW9kZWwoKSxcbiAgICAgICAgZ3JhcGg6IG5ldyBQdHIoX2dyYXBoKVxuICAgICAgfSk7XG4gICAgICBpZiAodHlwZW9mIHRoaXMuZ3JhcGggIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgdGhpcy5ncmFwaC5sb2FkKGcgPT4ge1xuICAgICAgICAgIGcuYWRkVmVydGV4KHRoaXMpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgaWYgKHR5cGVvZiBfcmVsYXRpb25zICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KF9yZWxhdGlvbnMpIHx8IF9yZWxhdGlvbnMgaW5zdGFuY2VvZiBMc3QpXG4gICAgICAgICAgdGhpcy5hZGRSZWxhdGlvbnMoX3JlbGF0aW9ucylcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHRoaXMuYWRkUmVsYXRpb24oX3JlbGF0aW9ucylcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBndWlkKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmNvbnN0cnVjdG9yLm5hbWUgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICBEYXRlLm5vdygpLnRvU3RyaW5nKDE2KVxuICAgICk7XG4gIH1cblxuICBzNCgpIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcigoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMClcbiAgICAgIC50b1N0cmluZygxNilcbiAgICAgIC5zdWJzdHJpbmcoMSk7XG4gIH1cblxuICBoYXNSZWxhdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5yZWxhdGlvbnMubGVuZ3RoICE9PSAwO1xuICB9XG5cblxuXG4gIGFkZFJlbGF0aW9uKF9yZWxhdGlvbikge1xuICAgIHRoaXMuZ3JhcGgubG9hZChncmFwaCA9PiB7XG4gICAgICBncmFwaC5hZGRSZWxhdGlvbihfcmVsYXRpb24pXG4gICAgICBncmFwaC5fYWRkTm90RXhpc3RpbmdWZXJ0aWNlc0Zyb21SZWxhdGlvbihfcmVsYXRpb24pXG4gICAgfSlcbiAgICBpZiAodHlwZW9mIHRoaXMucmVsYXRpb25zW19yZWxhdGlvbi50eXBlLmdldCgpXSAhPT0gXCJ1bmRlZmluZWRcIilcbiAgICAgIHRoaXMucmVsYXRpb25zW19yZWxhdGlvbi50eXBlLmdldCgpXS5sb2FkKHJlbGF0aW9uTGlzdCA9PiB7XG4gICAgICAgIHJlbGF0aW9uTGlzdC5wdXNoKF9yZWxhdGlvbilcbiAgICAgIH0pXG4gICAgZWxzZSB7XG4gICAgICBsZXQgbGlzdCA9IG5ldyBMc3QoKTtcbiAgICAgIGxpc3QucHVzaChfcmVsYXRpb24pXG4gICAgICB0aGlzLnJlbGF0aW9ucy5hZGRfYXR0cih7XG4gICAgICAgIFtfcmVsYXRpb24udHlwZS5nZXQoKV06IG5ldyBQdHIobGlzdClcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgYWRkUmVsYXRpb25zKF9yZWxhdGlvbnMpIHtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX3JlbGF0aW9ucy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIHRoaXMuYWRkUmVsYXRpb24oX3JlbGF0aW9uc1tpbmRleF0pO1xuICAgIH1cbiAgfVxuXG4gIHByb21pc2VMb2FkKF9wdHIpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBfcHRyLmxvYWQocmVzb2x2ZSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnZXRSZWxhdGlvbnMoX3R5cGUpIHtcbiAgICBsZXQgcmVzID0gW11cbiAgICBpZiAodHlwZW9mIF90eXBlID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5yZWxhdGlvbnMuYXR0cl9hdHRyaWJ1dGVfbmFtZXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IHRoaXMucmVsYXRpb25zLmF0dHJfYXR0cmlidXRlX25hbWVzW2luZGV4XTtcbiAgICAgICAgbGV0IHJlbExpc3QgPSBhd2FpdCB0aGlzLnByb21pc2VMb2FkKGF0dHJpYnV0ZSlcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJlbExpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgY29uc3QgcmVsYXRpb24gPSByZWxMaXN0W2luZGV4XTtcbiAgICAgICAgICByZXMucHVzaChyZWxhdGlvbilcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHJlbExpc3QgPSBhd2FpdCB0aGlzLnByb21pc2VMb2FkKHRoaXMucmVsYXRpb25zW190eXBlXSlcbiAgICAgIHJldHVybiByZWxMaXN0O1xuICAgIH1cbiAgfVxuXG5cblxuICBpblZlcnRleExpc3QoX3ZlcnRleGxpc3QpIHtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX3ZlcnRleGxpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gX3ZlcnRleGxpc3RbaW5kZXhdO1xuICAgICAgaWYgKGVsZW1lbnQuaWQuZ2V0KCkgPT09IHRoaXMuaWQuZ2V0KCkpXG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgYWxsQnV0TWUoX2xpc3QpIHtcbiAgICBsZXQgcmVzID0gW11cbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX2xpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCB2ZXJ0ZXggPSBfbGlzdFtpbmRleF07XG4gICAgICBpZiAodmVydGV4LmlkLmdldCgpICE9IHRoaXMuaWQuZ2V0KCkpIHtcbiAgICAgICAgcmVzLnB1c2godmVydGV4KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXROZWlnaGJvcnMoX3R5cGUpIHtcbiAgICBuZWlnaGJvcnMgPSBbXVxuICAgIGxldCByZWxhdGlvbnMgPSBhd2FpdCB0aGlzLmdldFJlbGF0aW9ucyhfdHlwZSlcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVsYXRpb25zLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgcmVsYXRpb24gPSByZWxhdGlvbnNbaW5kZXhdO1xuICAgICAgaWYgKHJlbGF0aW9uLmlzRGlyZWN0ZWQuZ2V0KCkpIHtcbiAgICAgICAgaWYgKHRoaXMuaW5WZXJ0ZXhMaXN0KHJlbGF0aW9uLnZlcnRleGxpc3QxKSlcbiAgICAgICAgICBuZWlnaGJvcnMgPSBuZWlnaGJvcnMuY29uY2F0KHJlbGF0aW9uLnZlcnRleGxpc3QyKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgbmVpZ2hib3JzID0gbmVpZ2hib3JzLmNvbmNhdChyZWxhdGlvbi52ZXJ0ZXhsaXN0MSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5laWdoYm9ycyA9IG5laWdoYm9ycy5jb25jYXQodGhpcy5hbGxCdXRNZShyZWxhdGlvbi52ZXJ0ZXhsaXN0MSkpO1xuICAgICAgICBuZWlnaGJvcnMgPSBuZWlnaGJvcnMuY29uY2F0KHRoaXMuYWxsQnV0TWUocmVsYXRpb24udmVydGV4bGlzdDIpKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbmVpZ2hib3JzXG4gIH1cblxuXG5cbiAgYXN5bmMgcmVtb3ZlUmVsYXRpb24oX3JlbGF0aW9uKSB7XG4gICAgbGV0IHJlbGF0aW9uTHN0ID0gYXdhaXQgdGhpcy5wcm9taXNlTG9hZCh0aGlzLnJlbGF0aW9uc1tfcmVsYXRpb25cbiAgICAgIC50eXBlXG4gICAgICAuZ2V0KCldKVxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCByZWxhdGlvbkxzdC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZVJlbGF0aW9uID0gcmVsYXRpb25Mc3RbaW5kZXhdO1xuICAgICAgaWYgKF9yZWxhdGlvbi5pZC5nZXQoKSA9PT0gY2FuZGlkYXRlUmVsYXRpb24uaWQuZ2V0KCkpXG4gICAgICAgIHJlbGF0aW9uTHN0LnNwbGljZShpbmRleCwgMSlcbiAgICB9XG4gIH1cblxuICBhc3luYyByZW1vdmVSZWxhdGlvbnMoX3JlbGF0aW9ucykge1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBfcmVsYXRpb25zLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgdGhpcy5yZW1vdmVSZWxhdGlvbihfcmVsYXRpb25zW2luZGV4XSlcbiAgICB9XG4gIH1cblxuICByZW1vdmVSZWxhdGlvblR5cGUoX3R5cGUpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShfdHlwZSkgfHwgX3R5cGUgaW5zdGFuY2VvZiBMc3QpXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX3R5cGUubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBfdHlwZVtpbmRleF07XG4gICAgICAgIHRoaXMucmVsYXRpb25zLnJlbV9hdHRyKHR5cGUpXG4gICAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLnJlbGF0aW9ucy5yZW1fYXR0cihfdHlwZSlcbiAgICB9XG4gIH1cblxufVxuXG5zcGluYWxDb3JlLnJlZ2lzdGVyX21vZGVscyhbU3BpbmFsTm9kZV0pOyJdfQ==
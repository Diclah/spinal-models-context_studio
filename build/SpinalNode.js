"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _Utilities = require("./Utilities");

const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;
let getViewer = function () {
  return globalType.v;
};

class SpinalNode extends globalType.Model {
  constructor(_name, _element, _graph, _relations) {
    super();
    if (FileSystem._sig_server) {
      this.add_attr({
        name: _name,
        id: this.guid(),
        element: new Ptr(_element),
        relations: new Model(),
        graph: new Ptr(_graph)
      });
      if (typeof this.graph !== "undefined") {
        this.graph.load(g => {
          g.classifyVertex(this);
        });
      }
      if (typeof _relations !== "undefined") {
        if (Array.isArray(_relations) || _relations instanceof Lst) this.addRelations(_relations);else this.addRelation(_relations);
      }
    }
  }

  guid() {
    return this.constructor.name + "-" + this.s4() + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + this.s4() + this.s4() + "-" + Date.now().toString(16);
  }

  s4() {
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  }

  hasRelation() {
    return this.relations.length !== 0;
  }

  addDirectedRelationChild(_relation) {
    let name = _relation.type.get();
    name = name.replace(/e?.$/, "edBy");
    this.addRelation(_relation, name);
  }

  addRelation(_relation, _name) {
    let name = _relation.type.get();
    if (typeof _name !== "undefined") {
      name = _name;
    }
    if (typeof this.relations[_relation.type.get()] !== "undefined") this.relations[_relation.type.get()].push(_relation);else {
      let list = new Lst();
      list.push(_relation);
      this.relations.add_attr({
        [name]: list
      });
    }
  }

  addRelation2(_relation, _name) {
    let classify = false;
    let name = _relation.type.get();
    if (typeof _name !== "undefined") {
      name = _name;
    }
    if (typeof this.relations[_relation.type.get()] !== "undefined") {
      if (_relation.isDirected.get()) {
        for (let index = 0; index < this.relations[_relation.type.get()].length; index++) {
          const element = this.relations[_relation.type.get()][index];
          if (_Utilities.Utilities.arraysEqual(_relation.getVertexList1Ids(), element.getVertexList1Ids())) {
            element.addNotExistingVerticestoVertexList2(_relation.vertexList2);
          } else {
            element.push(_relation);
            classify = true;
          }
        }
      } else {
        this.relations[_relation.type.get()].addNotExistingVerticestoRelation(_relation);
      }
    } else {
      if (_relation.isDirected.get()) {
        let list = new Lst();
        list.push(_relation);
        this.relations.add_attr({
          [name]: list
        });
        this._classifyRelation(_relation);
      } else {
        this.relations.add_attr({
          [name]: _relation
        });
        classify = true;
      }
    }
    if (classify) this._classifyRelation(_relation);
  }

  _classifyRelation(_relation) {
    this.graph.load(graph => {
      graph._classifyRelation(_relation);
    });
  }

  //TODO :NotWorking
  // addRelation(_relation) {
  //   this.addRelation(_relation)
  //   this.graph.load(graph => {
  //     graph._addNotExistingVerticesFromRelation(_relation)
  //   })
  // }
  //TODO :NotWorking
  // addRelations(_relations) {
  //   for (let index = 0; index < _relations.length; index++) {
  //     this.addRelation(_relations[index]);
  //   }
  // }


  getRelations(_type) {
    let res = [];
    if (typeof _type === "undefined") {
      for (let index = 0; index < this.relations._attribute_names.length; index++) {
        const relList = this.relations[this.relations._attribute_names[index]];
        for (let index = 0; index < relList.length; index++) {
          const relation = relList[index];
          res.push(relation);
        }
      }
      return res;
    } else {
      return this.relations[_type];
    }
  }

  inVertexList(_vertexlist) {
    for (let index = 0; index < _vertexlist.length; index++) {
      const element = _vertexlist[index];
      if (element.id.get() === this.id.get()) return true;
    }
    return false;
  }

  allButMe(_list) {
    let res = [];
    for (let index = 0; index < _list.length; index++) {
      const vertex = _list[index];
      if (vertex.id.get() != this.id.get()) {
        res.push(vertex);
      }
      return res;
    }
  }

  getNeighbors(_type) {
    let neighbors = [];
    let relations = this.getRelations(_type);
    for (let index = 0; index < relations.length; index++) {
      const relation = relations[index];
      if (relation.isDirected.get()) {
        if (this.inVertexList(relation.vertexList1)) neighbors = neighbors.concat(relation.vertexList2);else neighbors = neighbors.concat(relation.vertexList1);
      } else {
        neighbors = neighbors.concat(this.allButMe(relation.vertexList1));
        neighbors = neighbors.concat(this.allButMe(relation.vertexList2));
      }
    }
    return neighbors;
  }

  removeRelation(_relation) {
    let relationLst = this.relations[_relation.type.get()];
    for (let index = 0; index < relationLst.length; index++) {
      const candidateRelation = relationLst[index];
      if (_relation.id.get() === candidateRelation.id.get()) relationLst.splice(index, 1);
    }
  }

  removeRelations(_relations) {
    for (let index = 0; index < _relations.length; index++) {
      this.removeRelation(_relations[index]);
    }
  }

  removeRelationType(_type) {
    if (Array.isArray(_type) || _type instanceof Lst) for (let index = 0; index < _type.length; index++) {
      const type = _type[index];
      this.relations.rem_attr(type);
    } else {
      this.relations.rem_attr(_type);
    }
  }

}

exports.default = SpinalNode;
spinalCore.register_models([SpinalNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcGluYWxOb2RlLmpzIl0sIm5hbWVzIjpbInNwaW5hbENvcmUiLCJyZXF1aXJlIiwiZ2xvYmFsVHlwZSIsIndpbmRvdyIsImdsb2JhbCIsImdldFZpZXdlciIsInYiLCJTcGluYWxOb2RlIiwiTW9kZWwiLCJjb25zdHJ1Y3RvciIsIl9uYW1lIiwiX2VsZW1lbnQiLCJfZ3JhcGgiLCJfcmVsYXRpb25zIiwiRmlsZVN5c3RlbSIsIl9zaWdfc2VydmVyIiwiYWRkX2F0dHIiLCJuYW1lIiwiaWQiLCJndWlkIiwiZWxlbWVudCIsIlB0ciIsInJlbGF0aW9ucyIsImdyYXBoIiwibG9hZCIsImciLCJjbGFzc2lmeVZlcnRleCIsIkFycmF5IiwiaXNBcnJheSIsIkxzdCIsImFkZFJlbGF0aW9ucyIsImFkZFJlbGF0aW9uIiwiczQiLCJEYXRlIiwibm93IiwidG9TdHJpbmciLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJzdWJzdHJpbmciLCJoYXNSZWxhdGlvbiIsImxlbmd0aCIsImFkZERpcmVjdGVkUmVsYXRpb25DaGlsZCIsIl9yZWxhdGlvbiIsInR5cGUiLCJnZXQiLCJyZXBsYWNlIiwicHVzaCIsImxpc3QiLCJhZGRSZWxhdGlvbjIiLCJjbGFzc2lmeSIsImlzRGlyZWN0ZWQiLCJpbmRleCIsIlV0aWxpdGllcyIsImFycmF5c0VxdWFsIiwiZ2V0VmVydGV4TGlzdDFJZHMiLCJhZGROb3RFeGlzdGluZ1ZlcnRpY2VzdG9WZXJ0ZXhMaXN0MiIsInZlcnRleExpc3QyIiwiYWRkTm90RXhpc3RpbmdWZXJ0aWNlc3RvUmVsYXRpb24iLCJfY2xhc3NpZnlSZWxhdGlvbiIsImdldFJlbGF0aW9ucyIsIl90eXBlIiwicmVzIiwiX2F0dHJpYnV0ZV9uYW1lcyIsInJlbExpc3QiLCJyZWxhdGlvbiIsImluVmVydGV4TGlzdCIsIl92ZXJ0ZXhsaXN0IiwiYWxsQnV0TWUiLCJfbGlzdCIsInZlcnRleCIsImdldE5laWdoYm9ycyIsIm5laWdoYm9ycyIsInZlcnRleExpc3QxIiwiY29uY2F0IiwicmVtb3ZlUmVsYXRpb24iLCJyZWxhdGlvbkxzdCIsImNhbmRpZGF0ZVJlbGF0aW9uIiwic3BsaWNlIiwicmVtb3ZlUmVsYXRpb25zIiwicmVtb3ZlUmVsYXRpb25UeXBlIiwicmVtX2F0dHIiLCJyZWdpc3Rlcl9tb2RlbHMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQU1BOztBQU5BLE1BQU1BLGFBQWFDLFFBQVEseUJBQVIsQ0FBbkI7QUFDQSxNQUFNQyxhQUFhLE9BQU9DLE1BQVAsS0FBa0IsV0FBbEIsR0FBZ0NDLE1BQWhDLEdBQXlDRCxNQUE1RDtBQUNBLElBQUlFLFlBQVksWUFBVztBQUN6QixTQUFPSCxXQUFXSSxDQUFsQjtBQUNELENBRkQ7O0FBU2UsTUFBTUMsVUFBTixTQUF5QkwsV0FBV00sS0FBcEMsQ0FBMEM7QUFDdkRDLGNBQVlDLEtBQVosRUFBbUJDLFFBQW5CLEVBQTZCQyxNQUE3QixFQUFxQ0MsVUFBckMsRUFBaUQ7QUFDL0M7QUFDQSxRQUFJQyxXQUFXQyxXQUFmLEVBQTRCO0FBQzFCLFdBQUtDLFFBQUwsQ0FBYztBQUNaQyxjQUFNUCxLQURNO0FBRVpRLFlBQUksS0FBS0MsSUFBTCxFQUZRO0FBR1pDLGlCQUFTLElBQUlDLEdBQUosQ0FBUVYsUUFBUixDQUhHO0FBSVpXLG1CQUFXLElBQUlkLEtBQUosRUFKQztBQUtaZSxlQUFPLElBQUlGLEdBQUosQ0FBUVQsTUFBUjtBQUxLLE9BQWQ7QUFPQSxVQUFJLE9BQU8sS0FBS1csS0FBWixLQUFzQixXQUExQixFQUF1QztBQUNyQyxhQUFLQSxLQUFMLENBQVdDLElBQVgsQ0FBZ0JDLEtBQUs7QUFDbkJBLFlBQUVDLGNBQUYsQ0FBaUIsSUFBakI7QUFDRCxTQUZEO0FBR0Q7QUFDRCxVQUFJLE9BQU9iLFVBQVAsS0FBc0IsV0FBMUIsRUFBdUM7QUFDckMsWUFBSWMsTUFBTUMsT0FBTixDQUFjZixVQUFkLEtBQTZCQSxzQkFBc0JnQixHQUF2RCxFQUNFLEtBQUtDLFlBQUwsQ0FBa0JqQixVQUFsQixFQURGLEtB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Q0FBMUI7QUFDSDtBQUNGOztBQUVEMkIsa0JBQWdCbEUsVUFBaEIsRUFBNEI7QUFDMUIsU0FBSyxJQUFJdUMsUUFBUSxDQUFqQixFQUFvQkEsUUFBUXZDLFdBQVc0QixNQUF2QyxFQUErQ1csT0FBL0MsRUFBd0Q7QUFDdEQsV0FBS3VCLGNBQUwsQ0FBb0I5RCxXQUFXdUMsS0FBWCxDQUFwQjtBQUNEO0FBQ0Y7O0FBRUQ0QixxQkFBbUJuQixLQUFuQixFQUEwQjtBQUN4QixRQUFJbEMsTUFBTUMsT0FBTixDQUFjaUMsS0FBZCxLQUF3QkEsaUJBQWlCaEMsR0FBN0MsRUFDRSxLQUFLLElBQUl1QixRQUFRLENBQWpCLEVBQW9CQSxRQUFRUyxNQUFNcEIsTUFBbEMsRUFBMENXLE9BQTFDLEVBQW1EO0FBQ2pELFlBQU1SLE9BQU9pQixNQUFNVCxLQUFOLENBQWI7QUFDQSxXQUFLOUIsU0FBTCxDQUFlMkQsUUFBZixDQUF3QnJDLElBQXhCO0FBQ0QsS0FKSCxNQUtLO0FBQ0gsV0FBS3RCLFNBQUwsQ0FBZTJELFFBQWYsQ0FBd0JwQixLQUF4QjtBQUNEO0FBQ0Y7O0FBaE9zRDs7a0JBQXBDdEQsVTtBQW9PckJQLFdBQVdrRixlQUFYLENBQTJCLENBQUMzRSxVQUFELENBQTNCIiwiZmlsZSI6IlNwaW5hbE5vZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzcGluYWxDb3JlID0gcmVxdWlyZShcInNwaW5hbC1jb3JlLWNvbm5lY3RvcmpzXCIpO1xuY29uc3QgZ2xvYmFsVHlwZSA9IHR5cGVvZiB3aW5kb3cgPT09IFwidW5kZWZpbmVkXCIgPyBnbG9iYWwgOiB3aW5kb3c7XG5sZXQgZ2V0Vmlld2VyID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiBnbG9iYWxUeXBlLnY7XG59O1xuXG5pbXBvcnQge1xuICBVdGlsaXRpZXNcbn0gZnJvbSBcIi4vVXRpbGl0aWVzXCJcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTcGluYWxOb2RlIGV4dGVuZHMgZ2xvYmFsVHlwZS5Nb2RlbCB7XG4gIGNvbnN0cnVjdG9yKF9uYW1lLCBfZWxlbWVudCwgX2dyYXBoLCBfcmVsYXRpb25zKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoRmlsZVN5c3RlbS5fc2lnX3NlcnZlcikge1xuICAgICAgdGhpcy5hZGRfYXR0cih7XG4gICAgICAgIG5hbWU6IF9uYW1lLFxuICAgICAgICBpZDogdGhpcy5ndWlkKCksXG4gICAgICAgIGVsZW1lbnQ6IG5ldyBQdHIoX2VsZW1lbnQpLFxuICAgICAgICByZWxhdGlvbnM6IG5ldyBNb2RlbCgpLFxuICAgICAgICBncmFwaDogbmV3IFB0cihfZ3JhcGgpXG4gICAgICB9KTtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5ncmFwaCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICB0aGlzLmdyYXBoLmxvYWQoZyA9PiB7XG4gICAgICAgICAgZy5jbGFzc2lmeVZlcnRleCh0aGlzKTtcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2YgX3JlbGF0aW9ucyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShfcmVsYXRpb25zKSB8fCBfcmVsYXRpb25zIGluc3RhbmNlb2YgTHN0KVxuICAgICAgICAgIHRoaXMuYWRkUmVsYXRpb25zKF9yZWxhdGlvbnMpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICB0aGlzLmFkZFJlbGF0aW9uKF9yZWxhdGlvbnMpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ3VpZCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgRGF0ZS5ub3coKS50b1N0cmluZygxNilcbiAgICApO1xuICB9XG5cbiAgczQoKSB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDApXG4gICAgICAudG9TdHJpbmcoMTYpXG4gICAgICAuc3Vic3RyaW5nKDEpO1xuICB9XG5cbiAgaGFzUmVsYXRpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMucmVsYXRpb25zLmxlbmd0aCAhPT0gMDtcbiAgfVxuXG4gIGFkZERpcmVjdGVkUmVsYXRpb25DaGlsZChfcmVsYXRpb24pIHtcbiAgICBsZXQgbmFtZSA9IF9yZWxhdGlvbi50eXBlLmdldCgpXG4gICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvZT8uJC8sIFwiZWRCeVwiKVxuICAgIHRoaXMuYWRkUmVsYXRpb24oX3JlbGF0aW9uLCBuYW1lKVxuICB9XG5cbiAgYWRkUmVsYXRpb24oX3JlbGF0aW9uLCBfbmFtZSkge1xuICAgIGxldCBuYW1lID0gX3JlbGF0aW9uLnR5cGUuZ2V0KClcbiAgICBpZiAodHlwZW9mIF9uYW1lICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBuYW1lID0gX25hbWVcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLnJlbGF0aW9uc1tfcmVsYXRpb24udHlwZS5nZXQoKV0gIT09IFwidW5kZWZpbmVkXCIpXG4gICAgICB0aGlzLnJlbGF0aW9uc1tfcmVsYXRpb24udHlwZS5nZXQoKV0ucHVzaChfcmVsYXRpb24pO1xuICAgIGVsc2Uge1xuICAgICAgbGV0IGxpc3QgPSBuZXcgTHN0KCk7XG4gICAgICBsaXN0LnB1c2goX3JlbGF0aW9uKVxuICAgICAgdGhpcy5yZWxhdGlvbnMuYWRkX2F0dHIoe1xuICAgICAgICBbbmFtZV06IGxpc3RcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cblxuICBhZGRSZWxhdGlvbjIoX3JlbGF0aW9uLCBfbmFtZSkge1xuICAgIGxldCBjbGFzc2lmeSA9IGZhbHNlO1xuICAgIGxldCBuYW1lID0gX3JlbGF0aW9uLnR5cGUuZ2V0KClcbiAgICBpZiAodHlwZW9mIF9uYW1lICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBuYW1lID0gX25hbWVcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLnJlbGF0aW9uc1tfcmVsYXRpb24udHlwZS5nZXQoKV0gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIGlmIChfcmVsYXRpb24uaXNEaXJlY3RlZC5nZXQoKSkge1xuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5yZWxhdGlvbnNbX3JlbGF0aW9uLnR5cGUuZ2V0KCldLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLnJlbGF0aW9uc1tfcmVsYXRpb24udHlwZS5nZXQoKV1baW5kZXhdO1xuICAgICAgICAgIGlmIChVdGlsaXRpZXMuYXJyYXlzRXF1YWwoX3JlbGF0aW9uLmdldFZlcnRleExpc3QxSWRzKCksXG4gICAgICAgICAgICAgIGVsZW1lbnQuZ2V0VmVydGV4TGlzdDFJZHMoKSkpIHtcbiAgICAgICAgICAgIGVsZW1lbnQuYWRkTm90RXhpc3RpbmdWZXJ0aWNlc3RvVmVydGV4TGlzdDIoX3JlbGF0aW9uLnZlcnRleExpc3QyKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbGVtZW50LnB1c2goX3JlbGF0aW9uKTtcbiAgICAgICAgICAgIGNsYXNzaWZ5ID0gdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yZWxhdGlvbnNbX3JlbGF0aW9uLnR5cGUuZ2V0KCldLmFkZE5vdEV4aXN0aW5nVmVydGljZXN0b1JlbGF0aW9uKFxuICAgICAgICAgIF9yZWxhdGlvbilcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKF9yZWxhdGlvbi5pc0RpcmVjdGVkLmdldCgpKSB7XG4gICAgICAgIGxldCBsaXN0ID0gbmV3IExzdCgpO1xuICAgICAgICBsaXN0LnB1c2goX3JlbGF0aW9uKVxuICAgICAgICB0aGlzLnJlbGF0aW9ucy5hZGRfYXR0cih7XG4gICAgICAgICAgW25hbWVdOiBsaXN0XG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuX2NsYXNzaWZ5UmVsYXRpb24oX3JlbGF0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucmVsYXRpb25zLmFkZF9hdHRyKHtcbiAgICAgICAgICBbbmFtZV06IF9yZWxhdGlvblxuICAgICAgICB9KVxuICAgICAgICBjbGFzc2lmeSA9IHRydWVcblxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoY2xhc3NpZnkpIHRoaXMuX2NsYXNzaWZ5UmVsYXRpb24oX3JlbGF0aW9uKTtcbiAgfVxuXG4gIF9jbGFzc2lmeVJlbGF0aW9uKF9yZWxhdGlvbikge1xuICAgIHRoaXMuZ3JhcGgubG9hZChncmFwaCA9PiB7XG4gICAgICBncmFwaC5fY2xhc3NpZnlSZWxhdGlvbihfcmVsYXRpb24pXG4gICAgfSlcbiAgfVxuXG4gIC8vVE9ETyA6Tm90V29ya2luZ1xuICAvLyBhZGRSZWxhdGlvbihfcmVsYXRpb24pIHtcbiAgLy8gICB0aGlzLmFkZFJlbGF0aW9uKF9yZWxhdGlvbilcbiAgLy8gICB0aGlzLmdyYXBoLmxvYWQoZ3JhcGggPT4ge1xuICAvLyAgICAgZ3JhcGguX2FkZE5vdEV4aXN0aW5nVmVydGljZXNGcm9tUmVsYXRpb24oX3JlbGF0aW9uKVxuICAvLyAgIH0pXG4gIC8vIH1cbiAgLy9UT0RPIDpOb3RXb3JraW5nXG4gIC8vIGFkZFJlbGF0aW9ucyhfcmVsYXRpb25zKSB7XG4gIC8vICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IF9yZWxhdGlvbnMubGVuZ3RoOyBpbmRleCsrKSB7XG4gIC8vICAgICB0aGlzLmFkZFJlbGF0aW9uKF9yZWxhdGlvbnNbaW5kZXhdKTtcbiAgLy8gICB9XG4gIC8vIH1cblxuXG4gIGdldFJlbGF0aW9ucyhfdHlwZSkge1xuICAgIGxldCByZXMgPSBbXVxuICAgIGlmICh0eXBlb2YgX3R5cGUgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0aGlzLnJlbGF0aW9ucy5fYXR0cmlidXRlX25hbWVzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCByZWxMaXN0ID0gdGhpcy5yZWxhdGlvbnNbdGhpcy5yZWxhdGlvbnMuX2F0dHJpYnV0ZV9uYW1lc1tcbiAgICAgICAgICBpbmRleF1dO1xuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVsTGlzdC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICBjb25zdCByZWxhdGlvbiA9IHJlbExpc3RbaW5kZXhdO1xuICAgICAgICAgIHJlcy5wdXNoKHJlbGF0aW9uKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5yZWxhdGlvbnNbX3R5cGVdO1xuICAgIH1cbiAgfVxuXG5cblxuICBpblZlcnRleExpc3QoX3ZlcnRleGxpc3QpIHtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX3ZlcnRleGxpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gX3ZlcnRleGxpc3RbaW5kZXhdO1xuICAgICAgaWYgKGVsZW1lbnQuaWQuZ2V0KCkgPT09IHRoaXMuaWQuZ2V0KCkpXG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgYWxsQnV0TWUoX2xpc3QpIHtcbiAgICBsZXQgcmVzID0gW11cbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX2xpc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCB2ZXJ0ZXggPSBfbGlzdFtpbmRleF07XG4gICAgICBpZiAodmVydGV4LmlkLmdldCgpICE9IHRoaXMuaWQuZ2V0KCkpIHtcbiAgICAgICAgcmVzLnB1c2godmVydGV4KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gIH1cblxuICBnZXROZWlnaGJvcnMoX3R5cGUpIHtcbiAgICBsZXQgbmVpZ2hib3JzID0gW11cbiAgICBsZXQgcmVsYXRpb25zID0gdGhpcy5nZXRSZWxhdGlvbnMoX3R5cGUpXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJlbGF0aW9ucy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gcmVsYXRpb25zW2luZGV4XTtcbiAgICAgIGlmIChyZWxhdGlvbi5pc0RpcmVjdGVkLmdldCgpKSB7XG4gICAgICAgIGlmICh0aGlzLmluVmVydGV4TGlzdChyZWxhdGlvbi52ZXJ0ZXhMaXN0MSkpXG4gICAgICAgICAgbmVpZ2hib3JzID0gbmVpZ2hib3JzLmNvbmNhdChyZWxhdGlvbi52ZXJ0ZXhMaXN0MilcbiAgICAgICAgZWxzZVxuICAgICAgICAgIG5laWdoYm9ycyA9IG5laWdoYm9ycy5jb25jYXQocmVsYXRpb24udmVydGV4TGlzdDEpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZWlnaGJvcnMgPSBuZWlnaGJvcnMuY29uY2F0KHRoaXMuYWxsQnV0TWUocmVsYXRpb24udmVydGV4TGlzdDEpKTtcbiAgICAgICAgbmVpZ2hib3JzID0gbmVpZ2hib3JzLmNvbmNhdCh0aGlzLmFsbEJ1dE1lKHJlbGF0aW9uLnZlcnRleExpc3QyKSlcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5laWdoYm9yc1xuICB9XG5cblxuXG4gIHJlbW92ZVJlbGF0aW9uKF9yZWxhdGlvbikge1xuICAgIGxldCByZWxhdGlvbkxzdCA9IHRoaXMucmVsYXRpb25zW19yZWxhdGlvbi50eXBlLmdldCgpXVxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCByZWxhdGlvbkxzdC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGNhbmRpZGF0ZVJlbGF0aW9uID0gcmVsYXRpb25Mc3RbaW5kZXhdO1xuICAgICAgaWYgKF9yZWxhdGlvbi5pZC5nZXQoKSA9PT0gY2FuZGlkYXRlUmVsYXRpb24uaWQuZ2V0KCkpXG4gICAgICAgIHJlbGF0aW9uTHN0LnNwbGljZShpbmRleCwgMSlcbiAgICB9XG4gIH1cblxuICByZW1vdmVSZWxhdGlvbnMoX3JlbGF0aW9ucykge1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBfcmVsYXRpb25zLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgdGhpcy5yZW1vdmVSZWxhdGlvbihfcmVsYXRpb25zW2luZGV4XSlcbiAgICB9XG4gIH1cblxuICByZW1vdmVSZWxhdGlvblR5cGUoX3R5cGUpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShfdHlwZSkgfHwgX3R5cGUgaW5zdGFuY2VvZiBMc3QpXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX3R5cGUubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBfdHlwZVtpbmRleF07XG4gICAgICAgIHRoaXMucmVsYXRpb25zLnJlbV9hdHRyKHR5cGUpXG4gICAgICB9XG4gICAgZWxzZSB7XG4gICAgICB0aGlzLnJlbGF0aW9ucy5yZW1fYXR0cihfdHlwZSlcbiAgICB9XG4gIH1cblxufVxuXG5zcGluYWxDb3JlLnJlZ2lzdGVyX21vZGVscyhbU3BpbmFsTm9kZV0pOyJdfQ==
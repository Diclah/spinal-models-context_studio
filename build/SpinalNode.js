"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _Utilities = require("./Utilities");

const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;
let getViewer = function () {
  return globalType.v;
};

class SpinalNode extends globalType.Model {
  constructor(_name, _element, _graph, _relations, name = "SpinalNode") {
    super();
    if (FileSystem._sig_server) {
      this.add_attr({
        name: _name,
        id: _Utilities.Utilities.guid(this.constructor.name),
        element: new Ptr(_element),
        relations: new Model(),
        graph: _graph
      });
      if (typeof this.graph !== "undefined") {
        this.graph.classifyNode(this);
      }
      if (typeof _relations !== "undefined") {
        if (Array.isArray(_relations) || _relations instanceof Lst) this.addRelations(_relations);else this.addRelation(_relations);
      }
    }
  }

  hasRelation() {
    return this.relations.length !== 0;
  }

  addDirectedRelationParent(_relation) {
    let name = _relation.type.get();
    name = name.concat("<");
    this.addRelation(_relation, name);
  }

  addDirectedRelationChild(_relation) {
    let name = _relation.type.get();
    name = name.concat(">");
    this.addRelation(_relation, name);
  }

  addNonDirectedRelation(_relation) {
    let name = _relation.type.get();
    name = name.concat("-");
    this.addRelation(_relation, name);
  }

  addRelation(_relation, _name) {
    let name = _relation.type.get();
    if (typeof _name !== "undefined") {
      name = _name;
    }
    if (typeof this.relations[name] !== "undefined") this.relations[name].push(_relation);else {
      let list = new Lst();
      list.push(_relation);
      this.relations.add_attr({
        [name]: list
      });
    }
  }

  addRelation2(_relation, _name) {
    let classify = false;
    let name = _relation.type.get();
    if (typeof _name !== "undefined") {
      name = _name;
    }
    if (typeof this.relations[_relation.type.get()] !== "undefined") {
      if (_relation.isDirected.get()) {
        for (let index = 0; index < this.relations[_relation.type.get()].length; index++) {
          const element = this.relations[_relation.type.get()][index];
          if (_Utilities.Utilities.arraysEqual(_relation.getNodeList1Ids(), element.getNodeList1Ids())) {
            element.addNotExistingVerticestoNodeList2(_relation.nodeList2);
          } else {
            element.push(_relation);
            classify = true;
          }
        }
      } else {
        this.relations[_relation.type.get()].addNotExistingVerticestoRelation(_relation);
      }
    } else {
      if (_relation.isDirected.get()) {
        let list = new Lst();
        list.push(_relation);
        this.relations.add_attr({
          [name]: list
        });
        this._classifyRelation(_relation);
      } else {
        this.relations.add_attr({
          [name]: _relation
        });
        classify = true;
      }
    }
    if (classify) this._classifyRelation(_relation);
  }

  _classifyRelation(_relation) {
    this.graph.load(graph => {
      graph._classifyRelation(_relation);
    });
  }

  //TODO :NotWorking
  // addRelation(_relation) {
  //   this.addRelation(_relation)
  //   this.graph.load(graph => {
  //     graph._addNotExistingVerticesFromRelation(_relation)
  //   })
  // }
  //TODO :NotWorking
  // addRelations(_relations) {
  //   for (let index = 0; index < _relations.length; index++) {
  //     this.addRelation(_relations[index]);
  //   }
  // }

  getRelations(_type) {
    let res = [];
    if (typeof _type === "undefined") {
      for (let i = 0; i < this.relations._attribute_names.length; i++) {
        const relList = this.relations[this.relations._attribute_names[i]];
        for (let j = 0; j < relList.length; j++) {
          const relation = relList[j];
          res.push(relation);
        }
      }
      return res;
    } else {
      if (!_type.includes('>', _type.length - 2) && !_type.includes('<', _type.length - 2) && !_type.includes('-', _type.length - 2)) {
        let t1 = _type.concat('>');
        res = _Utilities.Utilities.concat(res, this.getRelations(t1));
        let t2 = _type.concat('<');
        res = _Utilities.Utilities.concat(res, this.getRelations(t2));
        let t3 = _type.concat('-');
        res = _Utilities.Utilities.concat(res, this.getRelations(t3));
      }
      if (typeof this.relations[_type] !== "undefined") res = this.relations[_type];
    }
    return res;
  }

  inNodeList(_nodelist) {
    for (let index = 0; index < _nodelist.length; index++) {
      const element = _nodelist[index];
      if (element.id.get() === this.id.get()) return true;
    }
    return false;
  }

  getNeighbors(_type) {
    let neighbors = [];
    let relations = this.getRelations(_type);
    for (let index = 0; index < relations.length; index++) {
      const relation = relations[index];
      if (relation.isDirected.get()) {
        if (this.inNodeList(relation.nodeList1)) neighbors = _Utilities.Utilities.concat(neighbors, relation.nodeList2);else neighbors = _Utilities.Utilities.concat(neighbors, relation.nodeList1);
      } else {
        neighbors = _Utilities.Utilities.concat(neighbors, _Utilities.Utilities.allButMeById(relation.nodeList1));
        neighbors = _Utilities.Utilities.concat(neighbors, _Utilities.Utilities.allButMeById(relation.nodeList2));
      }
    }
    return neighbors;
  }

  removeRelation(_relation) {
    let relationLst = this.relations[_relation.type.get()];
    for (let index = 0; index < relationLst.length; index++) {
      const candidateRelation = relationLst[index];
      if (_relation.id.get() === candidateRelation.id.get()) relationLst.splice(index, 1);
    }
  }

  removeRelations(_relations) {
    for (let index = 0; index < _relations.length; index++) {
      this.removeRelation(_relations[index]);
    }
  }

  removeRelationType(_type) {
    if (Array.isArray(_type) || _type instanceof Lst) for (let index = 0; index < _type.length; index++) {
      const type = _type[index];
      this.relations.rem_attr(type);
    } else {
      this.relations.rem_attr(_type);
    }
  }

  toJson() {
    return {
      id: this.id.get(),
      name: this.name.get(),
      element: null
    };
  }

  toJsonWithRelations() {
    let relations = [];
    for (let index = 0; index < this.getRelations().length; index++) {
      const relation = this.getRelations()[index];
      relations.push(relation.toJson());
    }
    return {
      id: this.id.get(),
      name: this.name.get(),
      element: null,
      relations: relations
    };
  }

  async toIfc() {
    let element = await _Utilities.Utilities.promiseLoad(this.element);
    return element.toIfc();
  }
}

exports.default = SpinalNode;
spinalCore.register_models([SpinalNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcGluYWxOb2RlLmpzIl0sIm5hbWVzIjpbInNwaW5hbENvcmUiLCJyZXF1aXJlIiwiZ2xvYmFsVHlwZSIsIndpbmRvdyIsImdsb2JhbCIsImdldFZpZXdlciIsInYiLCJTcGluYWxOb2RlIiwiTW9kZWwiLCJjb25zdHJ1Y3RvciIsIl9uYW1lIiwiX2VsZW1lbnQiLCJfZ3JhcGgiLCJfcmVsYXRpb25zIiwibmFtZSIsIkZpbGVTeXN0ZW0iLCJfc2lnX3NlcnZlciIsImFkZF9hdHRyIiwiaWQiLCJVdGlsaXRpZXMiLCJndWlkIiwiZWxlbWVudCIsIlB0ciIsInJlbGF0aW9ucyIsImdyYXBoIiwiY2xhc3NpZnlOb2RlIiwiQXJyYXkiLCJpc0FycmF5IiwiTHN0IiwiYWRkUmVsYXRpb25zIiwiYWRkUmVsYXRpb24iLCJoYXNSZWxhdGlvbiIsImxlbmd0aCIsImFkZERpcmVjdGVkUmVsYXRpb25QYXJlbnQiLCJfcmVsYXRpb24iLCJ0eXBlIiwiZ2V0IiwiY29uY2F0IiwiYWRkRGlyZWN0ZWRSZWxhdGlvbkNoaWxkIiwiYWRkTm9uRGlyZWN0ZWRSZWxhdGlvbiIsInB1c2giLCJsaXN0IiwiYWRkUmVsYXRpb24yIiwiY2xhc3NpZnkiLCJpc0RpcmVjdGVkIiwiaW5kZXgiLCJhcnJheXNFcXVhbCIsImdldE5vZGVMaXN0MUlkcyIsImFkZE5vdEV4aXN0aW5nVmVydGljZXN0b05vZGVMaXN0MiIsIm5vZGVMaXN0MiIsImFkZE5vdEV4aXN0aW5nVmVydGljZXN0b1JlbGF0aW9uIiwiX2NsYXNzaWZ5UmVsYXRpb24iLCJsb2FkIiwiZ2V0UmVsYXRpb25zIiwiX3R5cGUiLCJyZXMiLCJpIiwiX2F0dHJpYnV0ZV9uYW1lcyIsInJlbExpc3QiLCJqIiwicmVsYXRpb24iLCJpbmNsdWRlcyIsInQxIiwidDIiLCJ0MyIsImluTm9kZUxpc3QiLCJfbm9kZWxpc3QiLCJnZXROZWlnaGJvcnMiLCJuZWlnaGJvcnMiLCJub2RlTGlzdDEiLCJhbGxCdXRNZUJ5SWQiLCJyZW1vdmVSZWxhdGlvbiIsInJlbGF0aW9uTHN0IiwiY2FuZGlkYXRlUmVsYXRpb24iLCJzcGxpY2UiLCJyZW1vdmVSZWxhdGlvbnMiLCJyZW1vdmVSZWxhdGlvblR5cGUiLCJyZW1fYXR0ciIsInRvSnNvbiIsInRvSnNvbldpdGhSZWxhdGlvbnMiLCJ0b0lmYyIsInByb21pc2VMb2FkIiwicmVnaXN0ZXJfbW9kZWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQTs7QUFOQSxNQUFNQSxhQUFhQyxRQUFRLHlCQUFSLENBQW5CO0FBQ0EsTUFBTUMsYUFBYSxPQUFPQyxNQUFQLEtBQWtCLFdBQWxCLEdBQWdDQyxNQUFoQyxHQUF5Q0QsTUFBNUQ7QUFDQSxJQUFJRSxZQUFZLFlBQVc7QUFDekIsU0FBT0gsV0FBV0ksQ0FBbEI7QUFDRCxDQUZEOztBQVFlLE1BQU1DLFVBQU4sU0FBeUJMLFdBQVdNLEtBQXBDLENBQTBDO0FBQ3ZEQyxjQUFZQyxLQUFaLEVBQW1CQyxRQUFuQixFQUE2QkMsTUFBN0IsRUFBcUNDLFVBQXJDLEVBQWlEQyxPQUMvQyxZQURGLEVBQ2dCO0FBQ2Q7QUFDQSxRQUFJQyxXQUFXQyxXQUFmLEVBQTRCO0FBQzFCLFdBQUtDLFFBQUwsQ0FBYztBQUNaSCxjQUFNSixLQURNO0FBRVpRLFlBQUlDLHFCQUFVQyxJQUFWLENBQWUsS0FBS1gsV0FBTCxDQUFpQkssSUFBaEMsQ0FGUTtBQUdaTyxpQkFBUyxJQUFJQyxHQUFKLENBQVFYLFFBQVIsQ0FIRztBQUlaWSxtQkFBVyxJQUFJZixLQUFKLEVBSkM7QUFLWmdCLGVBQU9aO0FBTEssT0FBZDtBQU9BLFVBQUksT0FBTyxLQUFLWSxLQUFaLEtBQXNCLFdBQTFCLEVBQXVDO0FBQ3JDLGFBQUtBLEtBQUwsQ0FBV0MsWUFBWCxDQUF3QixJQUF4QjtBQUNEO0FBQ0QsVUFBSSxPQUFPWixVQUFQLEtBQXNCLFdBQTFCLEVBQXVDO0FBQ3JDLFlBQUlhLE1BQU1DLE9BQU4sQ0FBY2QsVUFBZCxLQUE2QkEsc0JBQXNCZSxHQUF2RCxFQUNFLEtBQUtDLFlBQUws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QUFDcEIsUUFBSXhELFlBQVksRUFBaEI7QUFDQSxTQUFLLElBQUlzQixRQUFRLENBQWpCLEVBQW9CQSxRQUFRLEtBQUtRLFlBQUwsR0FBb0JyQixNQUFoRCxFQUF3RGEsT0FBeEQsRUFBaUU7QUFDL0QsWUFBTWUsV0FBVyxLQUFLUCxZQUFMLEdBQW9CUixLQUFwQixDQUFqQjtBQUNBdEIsZ0JBQVVpQixJQUFWLENBQWVvQixTQUFTa0IsTUFBVCxFQUFmO0FBQ0Q7QUFDRCxXQUFPO0FBQ0w1RCxVQUFJLEtBQUtBLEVBQUwsQ0FBUWtCLEdBQVIsRUFEQztBQUVMdEIsWUFBTSxLQUFLQSxJQUFMLENBQVVzQixHQUFWLEVBRkQ7QUFHTGYsZUFBUyxJQUhKO0FBSUxFLGlCQUFXQTtBQUpOLEtBQVA7QUFNRDs7QUFFRCxRQUFNeUQsS0FBTixHQUFjO0FBQ1osUUFBSTNELFVBQVUsTUFBTUYscUJBQVU4RCxXQUFWLENBQXNCLEtBQUs1RCxPQUEzQixDQUFwQjtBQUNBLFdBQU9BLFFBQVEyRCxLQUFSLEVBQVA7QUFDRDtBQWhQc0Q7O2tCQUFwQ3pFLFU7QUFtUHJCUCxXQUFXa0YsZUFBWCxDQUEyQixDQUFDM0UsVUFBRCxDQUEzQiIsImZpbGUiOiJTcGluYWxOb2RlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc3BpbmFsQ29yZSA9IHJlcXVpcmUoXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc1wiKTtcbmNvbnN0IGdsb2JhbFR5cGUgPSB0eXBlb2Ygd2luZG93ID09PSBcInVuZGVmaW5lZFwiID8gZ2xvYmFsIDogd2luZG93O1xubGV0IGdldFZpZXdlciA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gZ2xvYmFsVHlwZS52O1xufTtcblxuaW1wb3J0IHtcbiAgVXRpbGl0aWVzXG59IGZyb20gXCIuL1V0aWxpdGllc1wiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTcGluYWxOb2RlIGV4dGVuZHMgZ2xvYmFsVHlwZS5Nb2RlbCB7XG4gIGNvbnN0cnVjdG9yKF9uYW1lLCBfZWxlbWVudCwgX2dyYXBoLCBfcmVsYXRpb25zLCBuYW1lID1cbiAgICBcIlNwaW5hbE5vZGVcIikge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKEZpbGVTeXN0ZW0uX3NpZ19zZXJ2ZXIpIHtcbiAgICAgIHRoaXMuYWRkX2F0dHIoe1xuICAgICAgICBuYW1lOiBfbmFtZSxcbiAgICAgICAgaWQ6IFV0aWxpdGllcy5ndWlkKHRoaXMuY29uc3RydWN0b3IubmFtZSksXG4gICAgICAgIGVsZW1lbnQ6IG5ldyBQdHIoX2VsZW1lbnQpLFxuICAgICAgICByZWxhdGlvbnM6IG5ldyBNb2RlbCgpLFxuICAgICAgICBncmFwaDogX2dyYXBoXG4gICAgICB9KTtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5ncmFwaCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICB0aGlzLmdyYXBoLmNsYXNzaWZ5Tm9kZSh0aGlzKTtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2YgX3JlbGF0aW9ucyAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShfcmVsYXRpb25zKSB8fCBfcmVsYXRpb25zIGluc3RhbmNlb2YgTHN0KVxuICAgICAgICAgIHRoaXMuYWRkUmVsYXRpb25zKF9yZWxhdGlvbnMpO1xuICAgICAgICBlbHNlIHRoaXMuYWRkUmVsYXRpb24oX3JlbGF0aW9ucyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cblxuXG4gIGhhc1JlbGF0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnJlbGF0aW9ucy5sZW5ndGggIT09IDA7XG4gIH1cblxuICBhZGREaXJlY3RlZFJlbGF0aW9uUGFyZW50KF9yZWxhdGlvbikge1xuICAgIGxldCBuYW1lID0gX3JlbGF0aW9uLnR5cGUuZ2V0KCk7XG4gICAgbmFtZSA9IG5hbWUuY29uY2F0KFwiPFwiKTtcbiAgICB0aGlzLmFkZFJlbGF0aW9uKF9yZWxhdGlvbiwgbmFtZSk7XG4gIH1cblxuICBhZGREaXJlY3RlZFJlbGF0aW9uQ2hpbGQoX3JlbGF0aW9uKSB7XG4gICAgbGV0IG5hbWUgPSBfcmVsYXRpb24udHlwZS5nZXQoKTtcbiAgICBuYW1lID0gbmFtZS5jb25jYXQoXCI+XCIpO1xuICAgIHRoaXMuYWRkUmVsYXRpb24oX3JlbGF0aW9uLCBuYW1lKTtcbiAgfVxuXG4gIGFkZE5vbkRpcmVjdGVkUmVsYXRpb24oX3JlbGF0aW9uKSB7XG4gICAgbGV0IG5hbWUgPSBfcmVsYXRpb24udHlwZS5nZXQoKTtcbiAgICBuYW1lID0gbmFtZS5jb25jYXQoXCItXCIpO1xuICAgIHRoaXMuYWRkUmVsYXRpb24oX3JlbGF0aW9uLCBuYW1lKTtcbiAgfVxuXG4gIGFkZFJlbGF0aW9uKF9yZWxhdGlvbiwgX25hbWUpIHtcbiAgICBsZXQgbmFtZSA9IF9yZWxhdGlvbi50eXBlLmdldCgpO1xuICAgIGlmICh0eXBlb2YgX25hbWUgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIG5hbWUgPSBfbmFtZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLnJlbGF0aW9uc1tuYW1lXSAhPT0gXCJ1bmRlZmluZWRcIilcbiAgICAgIHRoaXMucmVsYXRpb25zW25hbWVdLnB1c2goX3JlbGF0aW9uKTtcbiAgICBlbHNlIHtcbiAgICAgIGxldCBsaXN0ID0gbmV3IExzdCgpO1xuICAgICAgbGlzdC5wdXNoKF9yZWxhdGlvbik7XG4gICAgICB0aGlzLnJlbGF0aW9ucy5hZGRfYXR0cih7XG4gICAgICAgIFtuYW1lXTogbGlzdFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYWRkUmVsYXRpb24yKF9yZWxhdGlvbiwgX25hbWUpIHtcbiAgICBsZXQgY2xhc3NpZnkgPSBmYWxzZTtcbiAgICBsZXQgbmFtZSA9IF9yZWxhdGlvbi50eXBlLmdldCgpO1xuICAgIGlmICh0eXBlb2YgX25hbWUgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIG5hbWUgPSBfbmFtZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLnJlbGF0aW9uc1tfcmVsYXRpb24udHlwZS5nZXQoKV0gIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIGlmIChfcmVsYXRpb24uaXNEaXJlY3RlZC5nZXQoKSkge1xuICAgICAgICBmb3IgKFxuICAgICAgICAgIGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5yZWxhdGlvbnNbX3JlbGF0aW9uLnR5cGUuZ2V0KCldLmxlbmd0aDsgaW5kZXgrK1xuICAgICAgICApIHtcbiAgICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5yZWxhdGlvbnNbX3JlbGF0aW9uLnR5cGUuZ2V0KCldW2luZGV4XTtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBVdGlsaXRpZXMuYXJyYXlzRXF1YWwoXG4gICAgICAgICAgICAgIF9yZWxhdGlvbi5nZXROb2RlTGlzdDFJZHMoKSxcbiAgICAgICAgICAgICAgZWxlbWVudC5nZXROb2RlTGlzdDFJZHMoKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgZWxlbWVudC5hZGROb3RFeGlzdGluZ1ZlcnRpY2VzdG9Ob2RlTGlzdDIoX3JlbGF0aW9uLm5vZGVMaXN0Mik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVsZW1lbnQucHVzaChfcmVsYXRpb24pO1xuICAgICAgICAgICAgY2xhc3NpZnkgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5yZWxhdGlvbnNbX3JlbGF0aW9uLnR5cGUuZ2V0KCldLmFkZE5vdEV4aXN0aW5nVmVydGljZXN0b1JlbGF0aW9uKFxuICAgICAgICAgIF9yZWxhdGlvblxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoX3JlbGF0aW9uLmlzRGlyZWN0ZWQuZ2V0KCkpIHtcbiAgICAgICAgbGV0IGxpc3QgPSBuZXcgTHN0KCk7XG4gICAgICAgIGxpc3QucHVzaChfcmVsYXRpb24pO1xuICAgICAgICB0aGlzLnJlbGF0aW9ucy5hZGRfYXR0cih7XG4gICAgICAgICAgW25hbWVdOiBsaXN0XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9jbGFzc2lmeVJlbGF0aW9uKF9yZWxhdGlvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJlbGF0aW9ucy5hZGRfYXR0cih7XG4gICAgICAgICAgW25hbWVdOiBfcmVsYXRpb25cbiAgICAgICAgfSk7XG4gICAgICAgIGNsYXNzaWZ5ID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNsYXNzaWZ5KSB0aGlzLl9jbGFzc2lmeVJlbGF0aW9uKF9yZWxhdGlvbik7XG4gIH1cblxuICBfY2xhc3NpZnlSZWxhdGlvbihfcmVsYXRpb24pIHtcbiAgICB0aGlzLmdyYXBoLmxvYWQoZ3JhcGggPT4ge1xuICAgICAgZ3JhcGguX2NsYXNzaWZ5UmVsYXRpb24oX3JlbGF0aW9uKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vVE9ETyA6Tm90V29ya2luZ1xuICAvLyBhZGRSZWxhdGlvbihfcmVsYXRpb24pIHtcbiAgLy8gICB0aGlzLmFkZFJlbGF0aW9uKF9yZWxhdGlvbilcbiAgLy8gICB0aGlzLmdyYXBoLmxvYWQoZ3JhcGggPT4ge1xuICAvLyAgICAgZ3JhcGguX2FkZE5vdEV4aXN0aW5nVmVydGljZXNGcm9tUmVsYXRpb24oX3JlbGF0aW9uKVxuICAvLyAgIH0pXG4gIC8vIH1cbiAgLy9UT0RPIDpOb3RXb3JraW5nXG4gIC8vIGFkZFJlbGF0aW9ucyhfcmVsYXRpb25zKSB7XG4gIC8vICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IF9yZWxhdGlvbnMubGVuZ3RoOyBpbmRleCsrKSB7XG4gIC8vICAgICB0aGlzLmFkZFJlbGF0aW9uKF9yZWxhdGlvbnNbaW5kZXhdKTtcbiAgLy8gICB9XG4gIC8vIH1cblxuICBnZXRSZWxhdGlvbnMoX3R5cGUpIHtcbiAgICBsZXQgcmVzID0gW107XG4gICAgaWYgKHR5cGVvZiBfdHlwZSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgZm9yIChcbiAgICAgICAgbGV0IGkgPSAwOyBpIDwgdGhpcy5yZWxhdGlvbnMuX2F0dHJpYnV0ZV9uYW1lcy5sZW5ndGg7IGkrK1xuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IHJlbExpc3QgPSB0aGlzLnJlbGF0aW9uc1t0aGlzLnJlbGF0aW9ucy5fYXR0cmlidXRlX25hbWVzW1xuICAgICAgICAgIGldXTtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByZWxMaXN0Lmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgY29uc3QgcmVsYXRpb24gPSByZWxMaXN0W2pdO1xuICAgICAgICAgIHJlcy5wdXNoKHJlbGF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlcztcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFfdHlwZS5pbmNsdWRlcygnPicsIF90eXBlLmxlbmd0aCAtIDIpICYmXG4gICAgICAgICFfdHlwZS5pbmNsdWRlcygnPCcsIF90eXBlLmxlbmd0aCAtIDIpICYmXG4gICAgICAgICFfdHlwZS5pbmNsdWRlcygnLScsIF90eXBlLmxlbmd0aCAtIDIpKSB7XG4gICAgICAgIGxldCB0MSA9IF90eXBlLmNvbmNhdCgnPicpXG4gICAgICAgIHJlcyA9IFV0aWxpdGllcy5jb25jYXQocmVzLCB0aGlzLmdldFJlbGF0aW9ucyh0MSkpXG4gICAgICAgIGxldCB0MiA9IF90eXBlLmNvbmNhdCgnPCcpXG4gICAgICAgIHJlcyA9IFV0aWxpdGllcy5jb25jYXQocmVzLCB0aGlzLmdldFJlbGF0aW9ucyh0MikpXG4gICAgICAgIGxldCB0MyA9IF90eXBlLmNvbmNhdCgnLScpXG4gICAgICAgIHJlcyA9IFV0aWxpdGllcy5jb25jYXQocmVzLCB0aGlzLmdldFJlbGF0aW9ucyh0MykpXG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHRoaXMucmVsYXRpb25zW190eXBlXSAhPT0gXCJ1bmRlZmluZWRcIilcbiAgICAgICAgcmVzID0gdGhpcy5yZWxhdGlvbnNbX3R5cGVdO1xuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgaW5Ob2RlTGlzdChfbm9kZWxpc3QpIHtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX25vZGVsaXN0Lmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgZWxlbWVudCA9IF9ub2RlbGlzdFtpbmRleF07XG4gICAgICBpZiAoZWxlbWVudC5pZC5nZXQoKSA9PT0gdGhpcy5pZC5nZXQoKSkgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG5cbiAgZ2V0TmVpZ2hib3JzKF90eXBlKSB7XG4gICAgbGV0IG5laWdoYm9ycyA9IFtdO1xuICAgIGxldCByZWxhdGlvbnMgPSB0aGlzLmdldFJlbGF0aW9ucyhfdHlwZSk7XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHJlbGF0aW9ucy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gcmVsYXRpb25zW2luZGV4XTtcbiAgICAgIGlmIChyZWxhdGlvbi5pc0RpcmVjdGVkLmdldCgpKSB7XG4gICAgICAgIGlmICh0aGlzLmluTm9kZUxpc3QocmVsYXRpb24ubm9kZUxpc3QxKSlcbiAgICAgICAgICBuZWlnaGJvcnMgPSBVdGlsaXRpZXMuY29uY2F0KG5laWdoYm9ycywgcmVsYXRpb24ubm9kZUxpc3QyKTtcbiAgICAgICAgZWxzZSBuZWlnaGJvcnMgPSBVdGlsaXRpZXMuY29uY2F0KG5laWdoYm9ycywgcmVsYXRpb24ubm9kZUxpc3QxKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5laWdoYm9ycyA9IFV0aWxpdGllcy5jb25jYXQobmVpZ2hib3JzLCBVdGlsaXRpZXMuYWxsQnV0TWVCeUlkKFxuICAgICAgICAgIHJlbGF0aW9uLm5vZGVMaXN0MSkpO1xuICAgICAgICBuZWlnaGJvcnMgPSBVdGlsaXRpZXMuY29uY2F0KG5laWdoYm9ycywgVXRpbGl0aWVzLmFsbEJ1dE1lQnlJZChcbiAgICAgICAgICByZWxhdGlvbi5ub2RlTGlzdDIpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5laWdoYm9ycztcbiAgfVxuXG4gIHJlbW92ZVJlbGF0aW9uKF9yZWxhdGlvbikge1xuICAgIGxldCByZWxhdGlvbkxzdCA9IHRoaXMucmVsYXRpb25zW19yZWxhdGlvbi50eXBlLmdldCgpXTtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcmVsYXRpb25Mc3QubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBjYW5kaWRhdGVSZWxhdGlvbiA9IHJlbGF0aW9uTHN0W2luZGV4XTtcbiAgICAgIGlmIChfcmVsYXRpb24uaWQuZ2V0KCkgPT09IGNhbmRpZGF0ZVJlbGF0aW9uLmlkLmdldCgpKVxuICAgICAgICByZWxhdGlvbkxzdC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZVJlbGF0aW9ucyhfcmVsYXRpb25zKSB7XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IF9yZWxhdGlvbnMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICB0aGlzLnJlbW92ZVJlbGF0aW9uKF9yZWxhdGlvbnNbaW5kZXhdKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVSZWxhdGlvblR5cGUoX3R5cGUpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShfdHlwZSkgfHwgX3R5cGUgaW5zdGFuY2VvZiBMc3QpXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgX3R5cGUubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBfdHlwZVtpbmRleF07XG4gICAgICAgIHRoaXMucmVsYXRpb25zLnJlbV9hdHRyKHR5cGUpO1xuICAgICAgfVxuICAgIGVsc2Uge1xuICAgICAgdGhpcy5yZWxhdGlvbnMucmVtX2F0dHIoX3R5cGUpO1xuICAgIH1cbiAgfVxuXG4gIHRvSnNvbigpIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoaXMuaWQuZ2V0KCksXG4gICAgICBuYW1lOiB0aGlzLm5hbWUuZ2V0KCksXG4gICAgICBlbGVtZW50OiBudWxsLFxuICAgIH1cbiAgfVxuXG4gIHRvSnNvbldpdGhSZWxhdGlvbnMoKSB7XG4gICAgbGV0IHJlbGF0aW9ucyA9IFtdXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuZ2V0UmVsYXRpb25zKCkubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCByZWxhdGlvbiA9IHRoaXMuZ2V0UmVsYXRpb25zKClbaW5kZXhdO1xuICAgICAgcmVsYXRpb25zLnB1c2gocmVsYXRpb24udG9Kc29uKCkpXG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBpZDogdGhpcy5pZC5nZXQoKSxcbiAgICAgIG5hbWU6IHRoaXMubmFtZS5nZXQoKSxcbiAgICAgIGVsZW1lbnQ6IG51bGwsXG4gICAgICByZWxhdGlvbnM6IHJlbGF0aW9uc1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHRvSWZjKCkge1xuICAgIGxldCBlbGVtZW50ID0gYXdhaXQgVXRpbGl0aWVzLnByb21pc2VMb2FkKHRoaXMuZWxlbWVudCk7XG4gICAgcmV0dXJuIGVsZW1lbnQudG9JZmMoKVxuICB9XG59XG5cbnNwaW5hbENvcmUucmVnaXN0ZXJfbW9kZWxzKFtTcGluYWxOb2RlXSk7Il19